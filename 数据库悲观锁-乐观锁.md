**数据库悲观锁-乐观锁**
*****************************
**悲观锁**
1. 定义

	1. 在关系型数据库中，悲观并发控制(又名悲观锁，Pessimistic Concurrency Control, PCC)是一种并发控制方法。可以阻止一个事务以影响其他用户的方式来修改数据。若一个事务执行的操作对某行数据进行了锁操作，那只有当这个事务把锁释放，其他事务才能够执行与该锁冲突的操作。  
	2. 悲观锁主要用于数据争用激烈的环境，以及并发冲突时使用锁保护数据的成本低于回滚事务的成本的环境中。
*悲观锁对数据被外界（包括本系统当前的其他事务，以及来自外部系统的事务处理）修改持保守态度（悲观）。在整个数据处理过程中，将数据处于锁定状态。*

2. 流程  

	1. 在对任意记录进行修改前，先尝试为该记录加上排他锁（exclusive locking）；
	2. 若加锁失败，说明该记录正在被修改，那当前查询可能要等待或抛出异常，具体的响应方式由开发者根据实际需要决定；
	3. 若加锁成功，则就可以对该记录进行修改，事务完成后就会解锁；
	4. 其间若有其他对该记录做修改或加排他锁的操作，会等解锁或抛出异常。

3. 优点与不足
	
	1. 保守策略：先取锁再访问，为数据处理的安全提供了保证。
	2. 效率方面会很差，加锁让数据库产生了额外的开销，还增加了死锁的概率；
	3. 在只读型事务中不会产生冲突，不需要锁，但悲观锁的使用会增加系统的开销；
	4. 降低了并行，一个事务锁定了某条记录，而其他事务需要等待解锁才可以继续操作。

**乐观锁**

1. 定义
	
	乐观并发控制（又名乐观锁，Optimistic Concurrency Control, OCC）是一种并发控制。假设很多用户并发的事务在处理时不会彼此互相影响，各事务能够在不产生锁的情况下处理各自影响的那部分数据。
	在提交数据更新之前，每个事务都会检查在该事务读取数据后，有没有其他事务又修改了数据。若其他事务有更新的话，则正在提交的事务进行回滚。
	
*乐观锁假设数据在一般情况下不会造成冲突，所以在数据进行更新提交时，才会正式对数据的冲突与否进行检测，若冲突，则返回错误信息给用户，让自行处理。*

2. 乐观锁的实现方式
相当于悲观锁，乐观锁在对数据进行处理时，不会使用数据库提供的锁机制。实现乐观锁的方式是记录数据版本。
*数据版本*
	
	数据版本是为数据增加一个版本标识，当读取数据时，将版本标识的值一同读出，数据每更新一次，同时对版本标识进行更新。
	当提交更新时，判断数据表对应记录的当前版本记录与第一次取出来的版本标识进行对比，若相等则进行更新，否则为失效数据。

*实现数据版本有两种方式：一种是版本号；一种是使用时间戳*

3. 优点与不足
	
	1. 乐观锁相信事务之间的数据竞争的概率很小，因此尽可能直接走下去，直到提交的时候才去锁定，所以不会产生锁和死锁；
	2. 阻止不了除了程序之外的数据库操作；
	3. 对表的设计增加了额外字段，增加了数据库的冗余；
	4. 当应用并发量高时，version值在频繁变化，则会导致大量请求失败，影响系统的可用性。
	

